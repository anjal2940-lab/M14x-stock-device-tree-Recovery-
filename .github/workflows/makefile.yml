name: Verify M14x Device Tree

on:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Branch
        uses: actions/checkout@v4
        with:
          ref: standardized-tree

      - name: Check Folder Structure
        run: |
          echo "Checking for required prebuilt files..."
          [ -f "prebuilt/kernel" ] && echo "✅ Kernel found" || echo "❌ Kernel MISSING"
          [ -f "prebuilt/dtbo.img" ] && echo "✅ DTBO found" || echo "❌ DTBO MISSING"
          [ -f "prebuilt/dtb/dtb.img" ] && echo "✅ DTB found in subfolder" || echo "❌ DTB MISSING in prebuilt/dtb/"

      - name: Verify DTB Integrity (Magic Number)
        run: |
          echo "Checking DTB Magic Number (should be d00dfeed)..."
          # Read first 4 bytes and convert to hex
          MAGIC=$(hexdump -n 4 -e '"%02x"' prebuilt/dtb/dtb.img)
          if [ "$MAGIC" == "d00dfeed" ]; then
            echo "✅ DTB Magic Number is valid: $MAGIC"
          else
            echo "❌ INVALID DTB! Found: $MAGIC. Expected: d00dfeed"
            exit 1
          fi

      - name: Verify Exynos 1330 Compatibility
        run: |
          echo "Searching for Exynos 1330 / s5e8535 identifiers..."
          # Look for the internal Samsung/Exynos platform strings
          STRINGS=$(strings prebuilt/dtb/dtb.img | grep -iE "s5e8535|erd8535|exynos1330" | sort -u)
          if [ ! -z "$STRINGS" ]; then
            echo "✅ Found matching platform strings:"
            echo "$STRINGS"
          else
            echo "❌ No matching Exynos 1330 strings found in DTB!"
            exit 1
          fi

      - name: Check BoardConfig Syntax
        run: |
          echo "Verifying BoardConfig.mk variables..."
          grep -E "BOARD_PREBUILT_DTBIMAGE_DIR|BOARD_INCLUDE_DTB_IN_BOOTIMG" BoardConfig.mk
