name: Fix Device Tree Structure

on:
  workflow_dispatch: # Allows you to run this manually

jobs:
  fix-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Reorganize Prebuilts and Update BoardConfig
        run: |
          # 1. Create the required DTB folder structure
          mkdir -p prebuilt/dtb
          
          # 2. Move dtb.img into the subdirectory if it's in the root
          if [ -f "prebuilt/dtb.img" ]; then
            mv prebuilt/dtb.img prebuilt/dtb/dtb.img
            echo "Moved dtb.img to prebuilt/dtb/"
          fi

          # 3. Clean and Update BoardConfig.mk
          # Remove the old specific file path line
          sed -i '/TARGET_PREBUILT_DTB :=/d' BoardConfig.mk
          
          # Remove existing DIR variable if present to avoid duplicates
          sed -i '/BOARD_PREBUILT_DTBIMAGE_DIR :=/d' BoardConfig.mk
          
          # Add the correct Directory variable for the Ninja build system
          # This must point to the folder containing the DTB
          sed -i '/TARGET_PREBUILT_KERNEL/a BOARD_PREBUILT_DTBIMAGE_DIR := $(DEVICE_PATH)/prebuilt/dtb' BoardConfig.mk
          
          echo "BoardConfig.mk updated with correct DTB directory."

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Fix: Reorganize DTB structure and update BoardConfig for Ninja" || echo "No changes to commit"
          git push
