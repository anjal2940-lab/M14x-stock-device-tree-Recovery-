name: Extract Raw DTB from Container

on:
  workflow_dispatch:

jobs:
  extract:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Branch
        uses: actions/checkout@v4
        with:
          ref: standardized-tree
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Tools
        run: sudo apt-get install -y python3

      - name: Extract Raw DTB
        run: |
          # This python script scans the file for the d00dfeed magic number
          # and clips the file to start exactly there.
          python3 << 'EOF'
          import os

          input_file = "prebuilt/dtb/dtb.img"
          output_file = "prebuilt/dtb/dtb_raw.img"
          magic = b'\xd0\x0d\xfe\xed'

          if not os.path.exists(input_file):
              print(f"Error: {input_file} not found")
              exit(1)

          with open(input_file, "rb") as f:
              data = f.read()
              
          offset = data.find(magic)
          if offset != -1:
              print(f"✅ Found DTB Magic at offset: {offset}")
              with open(output_file, "wb") as f_out:
                  f_out.write(data[offset:])
              print("✅ Extracted raw DTB to dtb_raw.img")
          else:
              print("❌ DTB Magic Number (d00dfeed) NOT FOUND in the file!")
              exit(1)
          EOF

      - name: Final Verification
        run: |
          # Verify the new file magic
          MAGIC=$(hexdump -n 4 -e '"%02x"' prebuilt/dtb/dtb_raw.img)
          echo "New file magic: $MAGIC"
          if [ "$MAGIC" == "d00dfeed" ]; then
            mv prebuilt/dtb/dtb_raw.img prebuilt/dtb/dtb.img
          else
            echo "Extraction failed to produce valid magic."
            exit 1
          fi

      - name: Commit Fixed DTB
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add prebuilt/dtb/dtb.img
          git commit -m "Fix: Extracted raw DTB from AVB container"
          git push origin standardized-tree
