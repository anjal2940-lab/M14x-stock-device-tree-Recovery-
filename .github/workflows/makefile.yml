name: Decompress and Fix DTB

on:
  workflow_dispatch:

jobs:
  decompress:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Branch
        uses: actions/checkout@v4
        with:
          ref: standardized-tree
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Raw DTB
        run: |
          cd prebuilt/dtb
          
          # Rename to identify as compressed
          mv dtb.img dtb.img.lz4
          
          # Attempt decompression using lz4 (common for Samsung)
          # If lz4 fails, we will try gunzip
          sudo apt-get install -y lz4
          lz4 -d dtb.img.lz4 dtb.img || true
          
          # Check if the result is now a valid DTB
          MAGIC=$(hexdump -n 4 -e '"%02x"' dtb.img)
          if [ "$MAGIC" == "d00dfeed" ]; then
            echo "✅ Successfully decompressed! New Magic: $MAGIC"
            rm dtb.img.lz4
          else
            echo "❌ LZ4 failed or Magic still wrong ($MAGIC). Trying GZIP..."
            mv dtb.img.lz4 dtb.img.gz
            gunzip -f dtb.img.gz || true
            MAGIC_GZ=$(hexdump -n 4 -e '"%02x"' dtb.img)
            if [ "$MAGIC_GZ" == "d00dfeed" ]; then
                echo "✅ Successfully decompressed via GZIP!"
            else
                echo "❌ Fatal: File is not a standard compressed DTB. Found: $MAGIC_GZ"
                exit 1
            fi
          fi

      - name: Commit Fixed DTB
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add prebuilt/dtb/dtb.img
          git commit -m "Fix: Decompressed dtb.img to raw FDT format"
          git push origin standardized-tree
