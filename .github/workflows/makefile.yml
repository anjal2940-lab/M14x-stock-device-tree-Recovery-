name: Fix Standardized Device Tree

on:
  workflow_dispatch:

jobs:
  fix-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Standardized Branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Reorganize and Patch BoardConfig
        run: |
          echo "Checking repository structure..."
          ls -F

          # 1. Create the DTB directory in the repo root
          mkdir -p prebuilt/dtb
          
          # 2. Move dtb.img if it is sitting in the root of prebuilt/
          if [ -f "prebuilt/dtb.img" ]; then
            mv prebuilt/dtb.img prebuilt/dtb/dtb.img
            echo "Moved dtb.img -> prebuilt/dtb/dtb.img"
          fi

          # 3. Patch BoardConfig.mk in the root
          if [ -f "BoardConfig.mk" ]; then
            # Clean out old variables
            sed -i '/TARGET_PREBUILT_DTB :=/d' BoardConfig.mk
            sed -i '/BOARD_PREBUILT_DTBIMAGE_DIR :=/d' BoardConfig.mk
            
            # Insert the new directory variable after the Kernel path
            # Standardized trees use $(DEVICE_PATH) which is set by the builder
            sed -i '/TARGET_PREBUILT_KERNEL/a BOARD_PREBUILT_DTBIMAGE_DIR := $(DEVICE_PATH)/prebuilt/dtb' BoardConfig.mk
            
            echo "BoardConfig.mk patched successfully."
          else
            echo "Error: BoardConfig.mk not found. This doesn't look like a standard branch."
            exit 1
          fi

      - name: Commit Fixes to Branch
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "Standardize: Move DTB to subdirectory and update BoardConfig" || echo "No changes"
          git push origin ${{ github.ref_name }}
