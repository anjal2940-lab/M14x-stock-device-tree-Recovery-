name: PitchBlack Recovery Project Builder

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'PBRP Manifest Branch'
        required: true
        default: 'android-12.1'
        type: choice
        options:
        - android-14.0
        - android-12.1
        - android-11.0
        - android-10.0
        - android-9.0
        - android-8.1
        - android-7.1
        - android-6.0
      DEVICE_TREE:
        description: 'Custom Recovery Tree URL'
        required: true
        default: 'https://github.com/anjal2940-lab/M14x-stock-device-tree-Recovery-'
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch (optional)'
        required: false
        default: 'standardized-tree'
      BUILD_TARGET:
        description: 'Build Target (use "pbrp" for Android 11+)'
        required: true
        default: 'pbrp'
        type: choice
        options:
        - pbrp
        - recovery
        - boot
        - vendorboot
      LDCHECK_PATH:
        description: 'Path for dependency check (optional)'
        required: false
        default: 'recovery/root/system/bin/vold'

jobs:
  build:
    name: Build PBRP by ${{ github.actor }}
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      DEBIAN_FRONTEND: noninteractive
    permissions:
      contents: write
      
    steps:
    - name: Initial Setup
      run: |
        echo "BUILD_START=$(date +%s)" >> $GITHUB_ENV
        echo "BUILD_DATE=$(TZ=UTC date +%Y%m%d)" >> $GITHUB_ENV
        
    - name: Checkout
      uses: actions/checkout@v6

    - name: Clean-up
      uses: rokibhasansagar/slimhub_actions@main

    - name: Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 24

    - name: Build PitchBlack Recovery
      uses: mlm-games/pitchblack-pbrp-builder-action@main
      id: build
      with:
        MANIFEST_BRANCH: ${{ inputs.MANIFEST_BRANCH }}
        DEVICE_TREE:  ${{ inputs.DEVICE_TREE }}
        DEVICE_TREE_BRANCH:  ${{ inputs.DEVICE_TREE_BRANCH }}
        BUILD_TARGET:  ${{ inputs.BUILD_TARGET }}
  
    - name: Upload Artifacts
      uses: actions/upload-artifact@v6
      with:
        name: PBRP-Recovery-m14x-${{ env.BUILD_DATE }}
        path: |
          work/out/target/product/m14x/*.img
          work/out/target/product/m14x/*.tar
          work/out/target/product/m14x/*.zip

    - name: Upload to Release
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        files: |
          work/out/target/product/m14x/*.img
          work/out/target/product/m14x/PBRP*.zip
          work/out/target/product/m14x/*.tar
        name: PBRP for m14x - ${{ env.BUILD_DATE }}
        tag_name: ${{ github.run_id }}
        body: |
          Automated PBRP build for Samsung M14 (m14x).
          Standardized Tree Branch: ${{ inputs.DEVICE_TREE_BRANCH }}
        prerelease: false
        draft: false

    - name: Run LDCHECK
      uses: mlm-games/ldcheck-action@main
      with:
        OUTPUT_DIR: work/out/target/product/m14x
        LDCHECKPATH: ${{ inputs.LDCHECK_PATH }}
      continue-on-error: true

    - name: Calculate Build Time
      if: always()
      run: |
        BUILD_END=$(date +%s)
        BUILD_DURATION=$((BUILD_END - BUILD_START))
        echo "Build completed in $((BUILD_DURATION / 60)) minutes."
